<!doctype html>
<html>
	<head>
		<meta charset = 'utf-8'>
		<title>寻路</title>
		<style type="text/css">
			body{
				margin:0;
				background-image: url(img/2017.jpg);
			}
			table{
				/*border:1px solid #ccc;*/
				border-collapse: collapse;
				font-family:'楷体';
			}
			td{
				border:1px solid #ccc;
				width:28px;
				height:28px;
			}
		</style>
	</head>

	<body>
		<div id="maintable">
		</div>
		<script type="text/javascript">	
			var SIZE = 15;
			var tdUrl = new Array("url(img/blue.png)","url(img/blue00.png)",
						"url(img/red.png)","url(img/yellow.png)",
						"url(img/green.png)","url(img/purple.png)");
			var infArray = new Array(SIZE*SIZE);
			var tdArray = new Array(SIZE);
			var pathmove = new Array(SIZE*SIZE);
			var beginI;
			var beginJ;
			var endI;
			var endJ;
			var click = 0;
			var num;
			var ok;
			var step;

			createTable();//创建表格
			initBall ();//为表格添加初始背景
			getBeginAndEnd()//获得起始位置
			function createTable(){
				var oDiv = document.getElementById("maintable");
				oDiv.innerHTML = "<center><table><caption>寻路</caption></table></center>";
				var oTable = oDiv.getElementsByTagName("table")[0];
				var oTbody = document.createElement("tbody");
				for(var i = 0; i<SIZE ; i++){
					var oTr = document.createElement("tr");
					tdArray[i] = new Array(SIZE);
					for(var j=0 ; j<SIZE ; j++){
						var oTd = document.createElement("td");
						oTr.appendChild(oTd);
						oTd.style.backgroundImage = '';
						tdArray[i][j] = oTd;
					}
					oTbody.appendChild(oTr);
				}
				oTable.appendChild(oTbody);
			}

			function initBall (){
				for(var i=0 ; i<14 ; i++){
					var ranBall = parseInt(Math.random()*6);
					var thisball = tdUrl[ranBall];
					var ranRow = parseInt(Math.random()*SIZE);
					var ranCell = parseInt(Math.random()*SIZE);
					if(tdArray[ranRow][ranCell].style.backgroundImage == ''){
						tdArray[ranRow][ranCell].style.backgroundImage = thisball;
					}
					//oTd[5][6].style.backgroundImage = tdUrl[ranBall];
				}
			}

			function gridArray(prepose,curI,curJ,g,f){
				this.prepos= prepose;
				this.curI = curI;
				this.curJ = curJ;
				this.g = g;
				this.f = f;
				this.flag = 1;
			}

			function getF(i,j){
				return Math.abs(i-endI)+Math.abs(j-endJ);
			}

			function getBeginAndEnd(){
				//为每一个td对象添加点击事件
				for (var i = 0; i < SIZE; i++) {
					for(var  j = 0 ; j < SIZE ; j++){
						tdArray[i][j].onclick=clickop;
					}
				}
			}

			//
			function clickop(){
				var i,j;
				for(i = 0 ; i < SIZE ; i++){
					for(j = 0 ; j < SIZE ; j++){
						if(this == tdArray[i][j] ){
							break;
						}
					}
					if(j<SIZE)
						break;
				}

				switch(click){
				case 0:
					if(this.style.backgroundImage != ''){
						beginI = i;
						beginJ = j;
						click = 1;
					}
					break;
				case 1:
					if(this.style.backgroundImage == ''){
						endI = i;
						endJ = j;
						searchMinPath();
						if(ok == 1){
							addPathmove();
							step--;
							window.setTimeout("moveBall();", 100);
						}
					}
					else{
						beginI = i;
						beginJ = j;
					}
					break;
				}
			}

			function putBeginIntoinfArray(){
				num = 0;
				infArray[num] = new gridArray(
					-1,	beginI,	beginJ,	0,getF(beginI,beginJ));
				num++;
				// alert(num);
			}

			function getMinGF(){
				var i = 0;
				var min;
				for(;i<num ; i++){
					if(infArray[i].flag == 1)
						break;
				}

				if(!(i < num))
					return -1;

				var pos = i;
				min = infArray[i].g+infArray[i].f;
				for( ; i < num ; i++){
					if( infArray[i].f+infArray.f <min && infArray[i].flag ==1){
						min = infArray[i].g+infArray[i].f;
						pos = i;
					}
				}
				//alert(infArray[pos].curI+" "+infArray[pos].curJ+" "+num);
				return pos;
			}

			function Addinf(prepos,curI,curJ,g,f){
				var i;
				for(i =0 ; i<num ; i++){
					if(infArray[i].curI==curI&&infArray[i].curJ==curJ){
						// alert("你好");
						break; 
					}
				}

				if(!(i < num )){
					infArray[num] = new gridArray(prepos,curI,curJ,g,f);
					num++;
					if(curI == endI && curJ == endJ) 
						ok = 1;
				}else{
					if(infArray[i].flag == 1){
						if(infArray[i].g+infArray[i].f>g+f)
							inf[i].prepos = prepos;
					}
				}
			}

			function searchMinPath(){
				putBeginIntoinfArray();//添加初始位置

				ok = 0;
				while( ok == 0){
					var pos = getMinGF();//获取g+f最小的

					if(pos == -1){
						alert("无路可走");
						click = 0;
						return;
					}else{
						infArray[pos].flag = 2;
						// alert(infArray[pos].prepos);
					}
					// alert(oTd);
					var curI = infArray[pos].curI;
					var curJ = infArray[pos].curJ;
					var g = infArray[pos].g+1;
					// alert(curI+" "+curJ);
					if(ok == 0 && curI > 0 && tdArray[curI-1][curJ].style.backgroundImage == ''){//上
						Addinf(pos,curI-1,curJ,g,getF(curI-1,curJ));
					}
					if(ok == 0 && curI < SIZE-1 && tdArray[curI+1][curJ].style.backgroundImage == ''){//下
						Addinf(pos,curI+1,curJ,g,getF(curI+1,curJ));
					}
					if(ok == 0 && curJ > 0 && tdArray[curI][curJ-1].style.backgroundImage == ''){//左
						Addinf(pos,curI,curJ-1,g,getF(curI,curJ-1));
					}
					if(ok == 0 && curJ < SIZE-1 && tdArray[curI][curJ+1].style.backgroundImage == ''){//右
						Addinf(pos,curI,curJ+1,g,getF(curI,curJ+1));
					}
				}
			}

			function addPathmove(){
				step = 0;
				num--;
				do{
					pathmove[step] = infArray[num];
					num = infArray[num].prepos;
					step++;
				}while(num != -1);
			}
			
			function moveBall(){
				var i = pathmove[step].curI;
				var j = pathmove[step].curJ;
				var m = pathmove[step-1].curI;
				var n = pathmove[step-1].curJ;
				tdArray[m][n].style.backgroundImage = tdArray[i][j].style.backgroundImage;
				tdArray[i][j].style.backgroundImage = '';
				step--;
				// alert(""+i+j+n+m);
				if(step > 0)
					window.setTimeout("moveBall();",100);
				else
					click = 0;
			}
		</script>	
	</body>
</html>